<div class="relative bg-white rounded-3xl shadow-2xl overflow-hidden max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
    
    <div class="bg-gray-900 p-8 text-white relative overflow-hidden">
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-32 h-32 bg-gray-800 rounded-full opacity-50 blur-2xl"></div>
        <div class="relative z-10 flex justify-between items-start">
            <div>
                <div class="flex items-center gap-3 mb-1">
                    <h2 class="text-3xl font-bold tracking-tight">{{ stock.name }}</h2>
                    <span class="bg-gray-700 text-gray-300 text-xs font-bold px-2 py-1 rounded">{{ stock.sector }}</span>
                </div>
                <div class="text-gray-400 text-sm font-medium">{{ stock.symbol }}</div>
            </div>
            <div class="text-right">
                <div class="text-3xl font-bold">₹{{ stock.current_price }}</div>
                {% set change = stock.current_price - stock.prev_close %}
                {% set pct = (change / stock.prev_close) * 100 if stock.prev_close else 0 %}
                <div class="text-sm font-bold {% if change >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                    {% if change > 0 %}+{% endif %}{{ "%.2f"|format(change) }} ({{ "%.2f"|format(pct) }}%)
                </div>
            </div>
        </div>
    </div>

    <div class="p-8 space-y-8">
        
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Key Statistics</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                    <div class="text-xs text-gray-500 mb-1">Market Cap</div>
                    <div class="font-bold text-gray-900">{{ stock.fmt_market_cap }}</div>
                </div>
                <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                    <div class="text-xs text-gray-500 mb-1">P/E Ratio</div>
                    <div class="font-bold text-gray-900">{{ "%.2f"|format(stock.pe_ratio) }}</div>
                </div>
                <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                    <div class="text-xs text-gray-500 mb-1">Div Yield</div>
                    <div class="font-bold text-gray-900 text-green-600">{{ "%.2f"|format(stock.dividend_yield) }}%</div>
                </div>
                <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                    <div class="text-xs text-gray-500 mb-1">Volume</div>
                    <div class="font-bold text-gray-900">{{ stock.volume }}</div>
                </div>
            </div>
        </div>

        <div>
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Intraday Performance</h3>
                <span class="text-[10px] text-red-500 font-bold animate-pulse">LIVE</span>
            </div>
            <div class="h-64 w-full bg-gray-50 rounded-xl border border-gray-100 p-2">
                <canvas id="stockDetailChart"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                    <span>Day Low: ₹{{ stock.day_low }}</span>
                    <span>Day High: ₹{{ stock.day_high }}</span>
                </div>
                <div class="h-2 bg-gray-100 rounded-full overflow-hidden relative">
                    {% set day_range = stock.day_high - stock.day_low %}
                    {% set day_pos = ((stock.current_price - stock.day_low) / day_range * 100) if day_range > 0 else 50 %}
                    <div class="absolute top-0 bottom-0 bg-gray-900 rounded-full w-2" style="left: {{ day_pos }}%"></div>
                    <div class="h-full bg-gray-200 w-full"></div>
                </div>
            </div>
            <div>
                <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                    <span>52W Low: ₹{{ stock.year_low }}</span>
                    <span>52W High: ₹{{ stock.year_high }}</span>
                </div>
                <div class="h-2 bg-gray-100 rounded-full overflow-hidden relative">
                    {% set year_range = stock.year_high - stock.year_low %}
                    {% set year_pos = ((stock.current_price - stock.year_low) / year_range * 100) if year_range > 0 else 50 %}
                    <div class="absolute top-0 bottom-0 bg-blue-500 rounded-full w-2" style="left: {{ year_pos }}%"></div>
                    <div class="h-full bg-blue-100 w-full"></div>
                </div>
            </div>
        </div>

        <div class="pt-4 border-t border-gray-100 flex justify-end">
            <button onclick="closeDeepDive()" class="bg-gray-900 hover:bg-black text-white px-6 py-3 rounded-xl font-bold text-sm transition-all shadow-lg active:scale-95">Close</button>
        </div>
    </div>
</div>

<script>
    (function() {
        const ctx = document.getElementById('stockDetailChart').getContext('2d');
        const startPrice = {{ stock.chart_prices[0] }};
        const endPrice = {{ stock.chart_prices[-1] }};
        const isUp = endPrice >= startPrice;
        const lineColor = isUp ? '#10B981' : '#EF4444';
        const fillColor = isUp ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ stock.chart_labels | tojson }},
                datasets: [{
                    label: 'Price',
                    data: {{ stock.chart_prices | tojson }},
                    borderColor: lineColor,
                    backgroundColor: fillColor,
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                scales: { x: { display: false }, y: { display: false } },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
            }
        });
    })();
</script>